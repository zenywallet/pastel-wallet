<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="/js/jquery-3.4.1.slim.min.js"></script>
  <script type="text/javascript" src="/js/jquery-qrcode.min.js"></script>
  <title>Seed Maker</title>
</head>
<body>
<div id="qrcode"></div>
<div id="seed"></div>
<script>
// Copyright (c) 2019 zenywallet
var base58_chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
var base58 = (function(base58_chars) {
  var base58_map = {};
  for(var i in base58_chars) {
    base58_map[base58_chars[i]] = Number(i);
  }
  var log58_256 = Math.log(256) / Math.log(58);
  var log256_58 = 1 / log58_256;
  function ceil_precision(x) {
    var precision = String(x).replace('.', '').length - x.toFixed().length;
    var multi = Number('1' + '0'.repeat(precision - 1));
    return Math.ceil(x * multi) / multi;
  }
  log58_256 = ceil_precision(log58_256);
  log256_58 = ceil_precision(log256_58);

  function obj_assign(obj, methods) {
    var o = Object.assign(obj, methods);
    var keys = Object.keys(methods);
    for(var i in keys) {
      Object.defineProperty(o, keys[i], {enumerable: false});
    }
    return o;
  }

  var methods = {
    toArray: function(str) {
      str = str || this;
      var array = new Uint8Array(str.length);
      for(var i in array) {
        array[i] = str.charCodeAt(i);
      }
      return obj_assign(array, methods);
    },

    toString: function(array) {
      array = array || this;
      var s = "";
      for(var i in array) {
        s += String.fromCharCode(array[i]);
      }
      return obj_assign(new String(s), methods);
    },

    enc: function(array) {
      array = array || this;
      var size = Math.ceil(array.length * log58_256);
      var buf = new Uint8Array(size);
      var carry;
      for(var i in array) {
        carry = array[i];
        for(var j = size - 1; j >= 0; j--) {
          carry += buf[j] * 256;
          buf[j] = carry % 58;
          carry /= 58;
        }
      }
      var enc;
      for(var i in buf) {
        if(enc) {
          enc += base58_chars[buf[i]];
        } else if(buf[i] != 0) {
          enc = base58_chars[buf[i]];
        }
      }
      return obj_assign(new String(enc), methods);
    },

    dec: function(str) {
      str = str || this;
      var size = Math.ceil(str.length * log256_58);
      var dec = new Uint8Array(size);
      var carry;
      for(var i in str) {
        carry = base58_map[str[i]];
        if(carry == null) {
          return null;
        }
        for(var j = size - 1; j >= 0; j--) {
          carry += dec[j] * 58;
          dec[j] = carry % 256;
          carry /= 256;
        }
      }
      for(var i in dec) {
        if(dec[i] != 0) {
          dec = dec.slice(i);
          break;
        }
      }
      return obj_assign(dec, methods);
    }
  }
  return methods;
})(base58_chars);

var crypto = window.crypto || window.msCrypto;
if(crypto && crypto.getRandomValues) {
  var priv = new Uint8Array(32);
  crypto.getRandomValues(priv);
  var priv_base58 = base58.enc(priv);
  var priv_dec = priv_base58.dec();
  var enc_err = 0;
  if(priv.length != priv_dec.length) {
    enc_err = 1;
  } else {
    for(var i in priv) {
      if(priv[i] != priv_dec[i]) {
        enc_err = 1;
        break;
      }
    }
  }
  if(enc_err) {
    throw new Error('base58 encode failed.');
  }

  var tags = new Uint8Array(6);
  crypto.getRandomValues(tags);
  var tag = "";
  for(var i in tags) {
    tag += base58_chars[tags[i] % 58]
  }
  var seedstr = 'seed:' + priv_base58 + ',tag:' + tag + ',gen:pastel-v0.1';
  document.getElementById('seed').innerHTML = seedstr;
  var s = 400;
  $('#qrcode').qrcode({
    render: 'canvas',
    ecLevel: 'Q',
    radius: 0.39,
    text: seedstr,
    size: s,
    mode: 2,
    label: 'seed',
    fontname: 'sans',
    fontcolor: '#393939'
  });
} else {
  throw new Error('Secure random number generation is not supported by this browser.');
}
</script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="/js/coin.js"></script>
  <script type="text/javascript" src="/js/require.js"></script>
  <script type="text/javascript" src="/js/zopfli.raw.min.js"></script>
  <script type="text/javascript" src="/js/rawinflate.min.js"></script>
  <title>test handshsake</title>
</head>
<body>
<script>
String.prototype.toByteArray=String.prototype.toByteArray||(function(e){for(var b=[],c=0,f=this.length;c<f;c++){var a=this.charCodeAt(c);if(55296<=a&&57343>=a&&c+1<f&&!(a&1024)){var d=this.charCodeAt(c+1);55296<=d&&57343>=d&&d&1024&&(a=65536+(a-55296<<10)+(d-56320),c++)}128>a?b.push(a):2048>a?b.push(192|a>>6,128|a&63):65536>a?(55296<=a&&57343>=a&&(a=e?65534:65533),b.push(224|a>>12,128|a>>6&63,128|a&63)):1114111<a?b.push(239,191,191^(e?1:2)):b.push(240|a>>18,128|a>>12&63,128|a>>6&63,128|a&63)}return b})

function start(supercop) {
  var seed = supercop.createSeed();
  var kp = supercop.createKeyPair(seed);
  var shared = null;
  var ws = new WebSocket('ws://localhost:5001/', 'pastel-v0.1');
  ws.binaryType = 'arraybuffer';
  ws.onmessage = function(evt) {
    if(typeof evt.data == 'object') {
      let data = new Uint8Array(evt.data, 0, evt.data.length);
      if(!shared && data.length == 32) {
        console.log('server publicKey=' + JSON.stringify(data));
        shared = supercop.keyExchange(data, kp.secretKey);
        console.log('shared=' + JSON.stringify(shared));
        var shared_hash = coin.crypto.sha256(shared);
        var shared_hash_uint8array = new Uint8Array(shared_hash);
        console.log('shared hash=' + JSON.stringify(shared_hash));
        console.log('shared hash=' + JSON.stringify(shared_hash_uint8array));
        console.log('shared hash=' + shared_hash.toString('hex'));
        var comp =  (new Zopfli.RawDeflate("test日本語".toByteArray(false))).compress();
        console.log(comp);
        var decomp = (new Zlib.RawInflate(comp)).decompress();
        console.log(decomp);
        ws.send(comp);
      } else {
        console.log(data);
      }
    } else if(typeof evt.data == 'string') {
      console.log(evt.data);
    }
  }

  ws.onopen = function(evt) {
    ws.send(kp.publicKey);
    console.log('client publicKey=' + JSON.stringify(kp.publicKey));
  }
}

requirejs(['js/supercop.wasm'], function(supercop) {
  supercop.ready(function() {
    start(supercop);
  });
})
</script>
</body>
</html>
